// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/dotnet
{
    "name": ".NET Aspire - Contribute",
    // Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
    "image": "mcr.microsoft.com/devcontainers/dotnet:dev-10.0-preview-noble",
    "features": {
        "ghcr.io/devcontainers/features/azure-cli:1": {},
        "ghcr.io/azure/azure-dev/azd:0": {},
        "ghcr.io/devcontainers/features/docker-in-docker": {},
        "ghcr.io/devcontainers/features/github-cli:1": {},
        "ghcr.io/devcontainers/features/dotnet": {
            "additionalVersions": [
                "8.0.403",
                "9.0"
            ]
        },
        "ghcr.io/devcontainers/features/node:1": {},
        "ghcr.io/devcontainers/features/python:1": {},
        "ghcr.io/devcontainers/features/kubectl-helm-minikube:1": {
            "version": "latest",
            "helm": "latest",
            "minikube": "latest"
        }
    },
    "hostRequirements": {
        "cpus": 8,
        "memory": "32gb",
        "storage": "64gb",
        "gpu": "optional"
    },
    "forwardPorts": [
        8080,
        8443,
        5000,
        5001,
        18888,
        4317,
        4318,
        9090,
        3000,
        3001,
        7777,
        8000,
        8888,
        9000,
        9001
    ],
    "portsAttributes": {
        "8080": {
            "label": "Aspire Dashboard HTTP",
            "onAutoForward": "notify"
        },
        "8443": {
            "label": "Aspire Dashboard HTTPS",
            "onAutoForward": "notify"
        },
        "5000": {
            "label": "App HTTP",
            "onAutoForward": "silent"
        },
        "5001": {
            "label": "App HTTPS",
            "onAutoForward": "silent"
        },
        "18888": {
            "label": "Aspire Dashboard",
            "onAutoForward": "notify"
        },
        "4317": {
            "label": "OTLP gRPC",
            "onAutoForward": "ignore"
        },
        "4318": {
            "label": "OTLP HTTP",
            "onAutoForward": "ignore"
        },
        "9090": {
            "label": "Prometheus",
            "onAutoForward": "ignore"
        },
        "3000": {
            "label": "Web App",
            "onAutoForward": "silent"
        },
        "3001": {
            "label": "Web App Alt",
            "onAutoForward": "silent"
        },
        "7777": {
            "label": "API Service",
            "onAutoForward": "silent"
        },
        "8000": {
            "label": "Service",
            "onAutoForward": "silent"
        },
        "8888": {
            "label": "Jupyter/Notebook",
            "onAutoForward": "ignore"
        },
        "9000": {
            "label": "Additional Service",
            "onAutoForward": "silent"
        },
        "9001": {
            "label": "Additional Service Alt",
            "onAutoForward": "silent"
        }
    },
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-dotnettools.csdevkit",
                "ms-azuretools.vscode-bicep",
                "ms-azuretools.azure-dev",
                "GitHub.copilot",
                "ms-kubernetes-tools.vscode-kubernetes-tools",
                "microsoft-aspire.aspire-vscode"
            ],
            "settings": {
                "remote.autoForwardPorts": true,
                "remote.autoForwardPortsSource": "hybrid",
                "remote.otherPortsAttributes": {
                    "onAutoForward": "ignore"
                },
                "dotnet.defaultSolution": "Aspire.slnx"
            }
        }
    },
    "onCreateCommand": "dotnet restore && chmod +x .devcontainer/*.sh 2>/dev/null || true",
    "postCreateCommand": "if [ -f .devcontainer/init-env.sh ]; then bash .devcontainer/init-env.sh; fi",
    "postStartCommand": "dotnet dev-certs https --trust",
    "remoteEnv": {
        // When the project is built the Aspire.Cli project produces an executable which can be useful to
        // have on the path for local testing within the devcontainer environment.
        "PATH": "${containerEnv:PATH}:/workspaces/aspire/artifacts/bin/Aspire.Cli/Debug/net8.0/",
        "GH_PAT": "${localEnv:GH_PAT}",
        "GITHUB_OWNER": "${localEnv:GITHUB_OWNER}",
        "GITHUB_RUNNER_TOKEN": "${localEnv:GITHUB_RUNNER_TOKEN}",
        "DOCKER_ACCESS_TOKEN": "${localEnv:DOCKER_ACCESS_TOKEN}",
        "DOCKER_USERNAME": "${localEnv:DOCKER_USERNAME}",
        // Additional useful environment variables for container networking
        "ASPIRE_ALLOW_UNSECURED_TRANSPORT": "true",
        "DOTNET_DASHBOARD_OTLP_ENDPOINT_URL": "http://localhost:4317",
        "DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS": "true"
    },
    "runArgs": [
        "--env-file=.devcontainer/.env",
        "--add-host=host.docker.internal:host-gateway",
        "--cap-add=SYS_PTRACE",
        "--security-opt=seccomp=unconfined"
    ]
    // Configure tool-specific properties.
    // "customizations": {},
    // Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
    // "remoteUser": "root"
}